
var geometry = 
    /* color: #d63000 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-49.23544421057619, -22.77868829009797],
           [-49.24788966040529, -22.778055196508003],
           [-49.24437060217775, -22.780350146795286],
           [-49.24471392493166, -22.780904094529454],
           [-49.24866213660158, -22.779242244579503],
           [-49.24874796729006, -22.780904094529454],
           [-49.2482329831592, -22.782170252332858],
           [-49.251580380009784, -22.78050841780599],
           [-49.255271099614276, -22.779479652954542],
           [-49.254584454106464, -22.78058755324249],
           [-49.25647272925295, -22.780904094529454],
           [-49.2566443906299, -22.781853713983683],
           [-49.253296993779315, -22.78343639838476],
           [-49.2537261472217, -22.785177330017213],
           [-49.257331036137714, -22.783119862973514],
           [-49.257588528203144, -22.785968655232043],
           [-49.25844683508791, -22.787234766026405],
           [-49.25793185095705, -22.78857999586701],
           [-49.258103512334, -22.793248631781665],
           [-49.257331036137714, -22.795701579813265],
           [-49.25673022131838, -22.798945733616737],
           [-49.25492777686037, -22.80298103669116],
           [-49.25312533240236, -22.80393050240393],
           [-49.25046458105959, -22.802506301354164],
           [-49.248833797978534, -22.799578730234774],
           [-49.24668803076662, -22.797125851965795],
           [-49.24488558630861, -22.79522681912243],
           [-49.23819079260744, -22.787393029049298],
           [-49.23698916296877, -22.789292170998916],
           [-49.23973574500002, -22.79134954493256],
           [-49.242568157719745, -22.79522681912243],
           [-49.23218264441408, -22.792140834334102],
           [-49.2302943692676, -22.78992521243837],
           [-49.230551861333026, -22.791982576821155],
           [-49.22874941687502, -22.791982576821155],
           [-49.23098101477541, -22.796967600239228],
           [-49.22420039038576, -22.79767973156202],
           [-49.224114559697284, -22.799024858354755],
           [-49.23003687720217, -22.799262232293202],
           [-49.23716082434572, -22.796097212459355],
           [-49.24325480322756, -22.798075358467166],
           [-49.242310665654315, -22.800607343469412],
           [-49.23741831641115, -22.80266454665025],
           [-49.23990740637697, -22.803218403739507],
           [-49.243340633916034, -22.801794195247993],
           [-49.24437060217775, -22.79815448371042],
           [-49.24788966040529, -22.800369971873483],
           [-49.250035427617206, -22.80361401456802],
           [-49.2522670255176, -22.805512930558123],
           [-49.25235285620607, -22.81018098654386],
           [-49.25097956519045, -22.81318744639595],
           [-49.24874796729006, -22.818488148175486],
           [-49.245572231816425, -22.81912105400329],
           [-49.24119486670412, -22.817459669931612],
           [-49.23922076086916, -22.81429507277281],
           [-49.23089518408693, -22.805433809586848],
           [-49.23518671851076, -22.810972166622168],
           [-49.228062771367206, -22.80931068315068],
           [-49.229092739628925, -22.810576577157377],
           [-49.23338427405275, -22.81302921332114],
           [-49.23441424231447, -22.814927998087036],
           [-49.236130856084, -22.817380555898826],
           [-49.23913493018068, -22.816747641981976],
           [-49.24239649634279, -22.821177977627972],
           [-49.23819079260744, -22.821969093825338],
           [-49.2181922421924, -22.82956357542288],
           [-49.21741976599611, -22.821177977627972],
           [-49.212870739506855, -22.821573536301226],
           [-49.21029581885256, -22.82038685683406],
           [-49.21003832678713, -22.817301441820067],
           [-49.21244158606447, -22.81382037685705],
           [-49.216132305668964, -22.812079811012293],
           [-49.21304240088381, -22.81263362982995],
           [-49.21304240088381, -22.810734813081154],
           [-49.21621813635744, -22.80978539478161],
           [-49.22128214697756, -22.80092383828758],
           [-49.223342083500995, -22.794989438157018],
           [-49.232869289921894, -22.782961594992457]]],
         [[[-49.198859766404134, -22.802926108448823],
           [-49.1997180732889, -22.805141519047993],
           [-49.2037521156473, -22.807356893629898],
           [-49.20864446489046, -22.811471065145337],
           [-49.203837946335774, -22.8143192649487],
           [-49.2092452797098, -22.81392368520404],
           [-49.20967443315218, -22.816297146438647],
           [-49.20838697282503, -22.817325633461945],
           [-49.209073618332845, -22.82033193560968],
           [-49.20692785112093, -22.8244457152016],
           [-49.20246465532015, -22.82950865790054],
           [-49.191821649949055, -22.831011682761627],
           [-49.18795926896761, -22.827768292588253],
           [-49.19087751237581, -22.82666077580351],
           [-49.190620020310384, -22.82468304484717],
           [-49.186585977951985, -22.827293643641053],
           [-49.18117864457796, -22.827926508536173],
           [-49.17989118425081, -22.826502558384394],
           [-49.17800290910433, -22.825632359292083],
           [-49.179376200119954, -22.818116772040693],
           [-49.178861215989095, -22.814952190150496],
           [-49.18074949113558, -22.815268651648463],
           [-49.183581903855305, -22.812736939077013],
           [-49.18203695146273, -22.809572232191847],
           [-49.18289525834749, -22.806723933139033],
           [-49.19139249650667, -22.8040338182504],
           [-49.1956840309305, -22.802609618280357]]],
         [[[-47.82963920793339, -22.205239842678544],
           [-47.83444572648808, -22.20714699316712],
           [-47.84843612870976, -22.210881754470332],
           [-47.85693336686894, -22.204047860463895],
           [-47.859250795457804, -22.205319307799613],
           [-47.861224901292765, -22.206908600773247],
           [-47.86311317643925, -22.208259485651112],
           [-47.8644006367664, -22.209530894834373],
           [-47.86680389604374, -22.20937196931639],
           [-47.869207155321085, -22.206908600773247],
           [-47.871181261156046, -22.205716632730145],
           [-47.873241197679484, -22.206113956535923],
           [-47.86921478844478, -22.215808308821014],
           [-47.87050224877193, -22.21994012423601],
           [-47.871532217033646, -22.221688163349626],
           [-47.87075974083736, -22.22438963548863],
           [-47.86990143395259, -22.228521198095144],
           [-47.86818482018306, -22.230428032081726],
           [-47.86560989952876, -22.231301988990957],
           [-47.860803380974076, -22.232970437050913],
           [-47.86372162438228, -22.2363072735909],
           [-47.86320664025142, -22.240597375258595],
           [-47.86166168785884, -22.24274237683668],
           [-47.85994507408931, -22.24496678823012],
           [-47.845096364982865, -22.249653825179127],
           [-47.833852544792435, -22.251480932686277],
           [-47.82715775109126, -22.24989214490145],
           [-47.81900383568599, -22.246873398454845],
           [-47.81084992028072, -22.23916735596304],
           [-47.80595757103755, -22.227249961029013],
           [-47.8087041530688, -22.215490471825166],
           [-47.804927602775834, -22.205160377512442],
           [-47.80758835411861, -22.200471853089546],
           [-47.81059242821529, -22.19983610890892],
           [-47.823638692863724, -22.19896195596018],
           [-47.82930351830318, -22.201266529267034],
           [-47.83016182518794, -22.203729996830432]]],
         [[[-47.81884987150858, -22.155895216450993],
           [-47.82193977629374, -22.154941296615085],
           [-47.825544665209755, -22.157644052687232],
           [-47.83049970466184, -22.17076586502556],
           [-47.829641397777074, -22.17505797041399],
           [-47.825864847484105, -22.191589299793172],
           [-47.82174497443723, -22.19874167591469],
           [-47.806638773265355, -22.20128465518745],
           [-47.800630625071996, -22.191748245442184],
           [-47.80260473090696, -22.17791930120435],
           [-47.80432134467649, -22.169096677543955],
           [-47.806638773265355, -22.167347983691993],
           [-47.80809789496946, -22.16575824313861],
           [-47.812389429393285, -22.162976153930305],
           [-47.814363535228246, -22.16170432339276],
           [-47.81676679450559, -22.158445205153924]]],
         [[[-47.89045479749551, -21.968810338477006],
           [-47.89032605146279, -21.97175544576428],
           [-47.88869526838174, -21.97263100642354],
           [-47.88697865461221, -21.971874840717508],
           [-47.88547661756387, -21.970919678281128],
           [-47.884274987925195, -21.97000430825147],
           [-47.88358834241738, -21.96873074013517],
           [-47.88521912549844, -21.965785570129],
           [-47.888051538218164, -21.96562637001071],
           [-47.889811067331934, -21.965944770068877]]],
         [[[-47.63828677795364, -21.362100393129033],
           [-47.65742702148391, -21.372491426305974],
           [-47.66463679931594, -21.381363186391482],
           [-47.66025943420364, -21.38440024195721],
           [-47.64798564575149, -21.382402186178425],
           [-47.648586460570826, -21.391193427508],
           [-47.62627048156692, -21.403819922337796],
           [-47.622150608520045, -21.42012087212865],
           [-47.62051982543899, -21.402860986309754],
           [-47.61803073547317, -21.395508934456284],
           [-47.62318057678176, -21.38543922017961],
           [-47.62352389953567, -21.381762802567113],
           [-47.621378132323755, -21.380404103117602],
           [-47.62249393127395, -21.376887410674353],
           [-47.62695712707473, -21.374809325424664],
           [-47.62798709533645, -21.370573137214365],
           [-47.62704295776321, -21.36865482299096],
           [-47.631591984252466, -21.36569737266235]]],
         [[[-47.6252405133052, -21.365377644725235],
           [-47.624382206420435, -21.36745586383985],
           [-47.62352389953567, -21.369933701932244],
           [-47.621120640258326, -21.373610416669244],
           [-47.617172428588404, -21.375768445359526],
           [-47.6127950634761, -21.384959692686017],
           [-47.61356753967239, -21.37872569226451],
           [-47.61348170898391, -21.373130850417933],
           [-47.61434001586868, -21.368574892686283],
           [-47.61519832275344, -21.366176963259292],
           [-47.61854571960403, -21.36465825431479],
           [-47.620863148192896, -21.36465825431479]]],
         [[[-45.328416137260916, -6.476107993738832],
           [-45.33802917437029, -6.4784959121079275],
           [-45.33699920610857, -6.484295095375143],
           [-45.3273861689992, -6.48327171493863]]]]),
    geometry2 = 
    /* color: #ff0eaf */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[-47.82579215189682, -21.910600655062275],
           [-47.827165442912445, -21.91251178384263],
           [-47.833173591105805, -21.911954373930385],
           [-47.8423574747728, -21.914104371572147],
           [-47.851112204997406, -21.91657284735981],
           [-47.84699233195053, -21.9267648104006],
           [-47.83806594034897, -21.928277617720756],
           [-47.82656462809311, -21.925650099981155],
           [-47.81760725843702, -21.9178468826386],
           [-47.816491459486826, -21.923579900328228],
           [-47.81185660230909, -21.92381877105545],
           [-47.8096250044087, -21.92158929534784],
           [-47.8136590467671, -21.919200532632868],
           [-47.81348738539015, -21.915458057140878],
           [-47.81640562879835, -21.914661773070435],
           [-47.82095465528761, -21.912034004051392]]],
         [[[-47.876015190640956, -21.97253495563185],
           [-47.87721682027963, -21.97938006658982],
           [-47.87524271444467, -21.983359630542736],
           [-47.87361193136361, -21.98312085985193],
           [-47.87112284139779, -21.982086182216825],
           [-47.86734629110482, -21.978026989430994],
           [-47.865028862515956, -21.975082012213687],
           [-47.864857201139, -21.97213697391403],
           [-47.86665964559701, -21.970306243646743],
           [-47.87361193136361, -21.96927147262193]]],
         [[[-47.92383538195377, -22.222943286029295],
           [-47.92718277880436, -22.226042001359257],
           [-47.9255519957233, -22.228584485869998],
           [-47.921002969234046, -22.226995438453653],
           [-47.91739808031803, -22.227551607097993],
           [-47.911046609370764, -22.226995438453653],
           [-47.90392266222721, -22.225962547975403],
           [-47.90349350878483, -22.224373470844107],
           [-47.90563927599674, -22.22334056105204],
           [-47.91044579455143, -22.2235789255255],
           [-47.90958748766666, -22.221592542533845],
           [-47.91121827074772, -22.220321242654215],
           [-47.916797265498694, -22.219765045333304],
           [-47.92057381579166, -22.220321242654215]]],
         [[[-47.74525946540672, -21.564174070792046],
           [-47.751353444288554, -21.56720731674173],
           [-47.760794820020976, -21.570001039753876],
           [-47.769549550245586, -21.572714890544294],
           [-47.775815190504375, -21.57447088456261],
           [-47.77899092597801, -21.575747957755606],
           [-47.775557698438945, -21.57758373075039],
           [-47.78087920112449, -21.578142439653597],
           [-47.78491324348289, -21.58037725371933],
           [-47.78894728584129, -21.582851471932788],
           [-47.79341048164207, -21.585325647881106],
           [-47.79469794196922, -21.590593107488203],
           [-47.79632872505027, -21.596019986650685],
           [-47.7965862171157, -21.60743173041698],
           [-47.80310934943992, -21.61956070886855],
           [-47.79718703193504, -21.622911957723716],
           [-47.772553624342265, -21.616129587890182],
           [-47.75967902107078, -21.61924153825904],
           [-47.75040930671531, -21.620598008482922],
           [-47.74053877754051, -21.615571025605927],
           [-47.730582417677226, -21.610144879707942],
           [-47.72251433296043, -21.605676136111704],
           [-47.72431677741844, -21.5935459934416],
           [-47.72800749702293, -21.58444771931817],
           [-47.73169821662742, -21.578701146402135],
           [-47.736333073805156, -21.5668880306832],
           [-47.74174040717918, -21.56457318572723]]],
         [[[-46.94358061877482, -19.58211756600523],
           [-47.021514883911536, -19.59279157994245],
           [-47.02735137072794, -19.655527522612243],
           [-46.932760135200546, -19.644545290772065]]],
         [[[-44.94285551995028, -6.477135226123505],
           [-45.076751393973716, -6.483275552306287],
           [-45.17150847405184, -6.479864269210176],
           [-45.26214568108309, -6.475088434123485],
           [-45.326690358817466, -6.505789441328633],
           [-45.38642851799715, -6.53171327578103],
           [-45.472259206473716, -6.564457251777978],
           [-45.6198879906534, -6.675634202739246],
           [-45.58967558830965, -6.7642848617352795],
           [-45.51757780998934, -6.740418968061929],
           [-45.41252104729403, -6.704958900484725],
           [-45.33561675041903, -6.713142222500585],
           [-45.263518972098716, -6.691319725192512],
           [-45.20515410393465, -6.6538100313049355],
           [-45.15983550041903, -6.6333489897582885],
           [-45.12687651604403, -6.612205020780217],
           [-45.0485989281534, -6.582192673727167],
           [-44.911956472098716, -6.5426281730450215],
           [-44.92362944573153, -6.510564985182835]]],
         [[[-47.879141963683125, -22.16347386834401],
           [-47.88030067797756, -22.16458670669313],
           [-47.88171688433742, -22.16494440286401],
           [-47.88283268328762, -22.165779023724923],
           [-47.88175979968166, -22.167925168909154],
           [-47.87875572558498, -22.170468705973818],
           [-47.874421275816914, -22.17197890933626],
           [-47.87218967791652, -22.170150766356894],
           [-47.874635852538105, -22.16494440286401],
           [-47.87755409594631, -22.163394379553587]]]]),
    geometry3 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-61.054896858853695, -1.9039875685852905],
          [-61.054896858853695, -25.377155195440796],
          [-40.840053108853695, -25.377155195440796],
          [-40.840053108853695, -1.9039875685852905]]], null, false),
    geometry4 = /* color: #98ff00 */ee.Geometry.MultiPolygon(
        [[[[-43.69254669174861, -5.480901026612671],
           [-43.70902618393611, -5.4781669954429715],
           [-43.70902618393611, -5.505506743084394],
           [-43.682933654639235, -5.5096075969337654]]],
         [[[-43.80934963608719, -5.729553378620965],
           [-43.76265774155594, -5.609294936058771],
           [-43.854668239602816, -5.53822144050059],
           [-43.876640895852816, -5.504048440755228],
           [-43.91921291733719, -5.4671393952968925],
           [-43.96590481186844, -5.435696560965316],
           [-44.02358303452469, -5.40151770501679],
           [-44.21859035874344, -5.374173231543818],
           [-44.28725490952469, -5.393314492253374],
           [-44.29549465561844, -5.426126676335341],
           [-44.327080348977816, -5.446633385713727],
           [-44.343559841165316, -5.46440530121198],
           [-44.36415920639969, -5.4739745758646965],
           [-44.384758571634066, -5.478075646704078],
           [-44.362785915384066, -5.501314515766259],
           [-44.37239895249344, -5.527286295011618],
           [-44.395744899759066, -5.534120784634932],
           [-44.420464138040316, -5.5546237791883755],
           [-44.354546169290316, -5.547789526819631],
           [-44.307170001575315, -5.580596001149464],
           [-44.27901516343094, -5.636628596426995],
           [-44.1780782737825, -5.652344868797745],
           [-44.06409590490208, -5.678995804356019],
           [-43.96865139389969, -5.728186946646787],
           [-43.88625393296219, -5.713155979353798]]],
         [[[-47.826109678121774, -22.224751742667955],
           [-47.83314779457685, -22.22379829031734],
           [-47.84001424965498, -22.218236355743148],
           [-47.84636572060224, -22.219030931329026],
           [-47.85597875771162, -22.22665862792034],
           [-47.861815244528024, -22.219507674520056],
           [-47.869797498556345, -22.216329355973386],
           [-47.86979745810784, -22.218474817261146],
           [-47.86863878449622, -22.22185181350872],
           [-47.868767530294626, -22.22554628134127],
           [-47.86855250298053, -22.227930087114526],
           [-47.86835924508716, -22.230313796589535],
           [-47.86816671547529, -22.23214077855871],
           [-47.867050554892664, -22.2343256552867],
           [-47.863274366232126, -22.23730492725051],
           [-47.86241605934736, -22.23825828774],
           [-47.86241605934736, -22.23937053344685],
           [-47.86149328175336, -22.239986248675308],
           [-47.86099979816639, -22.241396411740453],
           [-47.86018446144697, -22.24326332389416],
           [-47.85915449318525, -22.241118330291734],
           [-47.85743787941572, -22.2423099974585],
           [-47.84911230263349, -22.24413720076141],
           [-47.839327604147165, -22.248585943930074],
           [-47.82988622841474, -22.25065138379927],
           [-47.8249080484831, -22.250492504890783],
           [-47.81975820717451, -22.24874482500143],
           [-47.815638334127634, -22.24191277619576],
           [-47.817354947897165, -22.233014724789637],
           [-47.821818143697946, -22.23269692679065],
           [-47.82593801674482, -22.22157354295602]]]]);

// final step of general map 
// dissolve pasture (15) and agriculture (19) to the mosaic of agriculture and pasture (21)

// import cerrado regions
var regions = ee.Image('users/dhconciani/base/cerrado_regioes_c6_raster');

var version = 10;

// imports
var dir = 'projects/mapbiomas-workspace/COLECAO6/classificacao-test/';
//var dir = 'users/dhconciani/test/';
var prefixo = 'CERRADO_col6_';
var version_in = 'wetlandsv7_generalv9';
var version_out = 'final_v' + version;

// read collection 6 
var collection = ee.Image(dir + prefixo + version_in);

// list years
var yearsList = ['1985', '1986', '1987', '1988', '1989',
                 '1990', '1991', '1992', '1993', '1994',
                 '1995', '1996', '1997', '1998', '1999',
                 '2000', '2001', '2002', '2003', '2004',
                 '2005', '2006', '2007', '2008', '2009',
                 '2010', '2011', '2012', '2013', '2014',
                 '2015', '2016', '2017', '2018', '2019',
                 '2020'];
                 
// import mapbiomas palette
var palettes = require('users/mapbiomas/modules:Palettes.js');
var vis = {
    'min': 0,
    'max': 45,
    'palette': palettes.get('classification5')
};

// create an empty recipe
var remmaped_collection = ee.Image([]);

// remap classes
yearsList.forEach(function(process_year){
  // read image for the year i
  var image_i = collection.select(['classification_' + process_year]);
  // remap image i
  image_i = image_i.remap([3, 4, 11, 12, 15, 19, 25, 33],
                          [3, 4, 11, 12, 21, 21, 25, 33]);
                          
  // correct by geometry [wet to grassland]
  // convert 
  var image_i_geo;
  image_i_geo = image_i.remap([3, 4, 11, 12, 15, 19, 21, 25, 33],
                              [3, 4, 12, 12, 21, 21, 21, 25, 33]);
      
      image_i_geo = image_i_geo.clip(geometry);
      image_i_geo = image_i_geo.updateMask(image_i_geo.eq(12));

  // blend into data
  image_i = ee.ImageCollection([image_i, image_i_geo]).mosaic();

  // correct by geometry [wet to savanna]
    var image_i_geo2;
    image_i_geo2 = image_i.remap([3, 4, 11, 12, 15, 19, 21, 25, 33],
                                  [3, 4, 4, 12, 21, 21, 21, 25, 33]);
                                  
    image_i_geo2 = image_i_geo2.clip(geometry2);
    image_i_geo2 = image_i_geo2.updateMask(image_i_geo2.eq(4));

  // blend into data
  image_i = ee.ImageCollection([image_i, image_i_geo2]).mosaic();
  
  // correct by raster (Paresi, region 29) - wet to grassland
  var image_i_geo3;
      image_i_geo3 = image_i.remap([3, 4, 11, 12, 15, 19, 21, 25, 33],
                                   [3, 4, 12, 12, 21, 21, 21, 25, 33]);
      
      image_i_geo3 = image_i_geo3.updateMask(regions.eq(29));
      image_i_geo3 = image_i_geo3.updateMask(image_i_geo3.eq(12));
      
      // blend into data
      image_i = ee.ImageCollection([image_i, image_i_geo3]).mosaic();
      
    // corrigir transições entre região 2 e 4 
    var ref = ee.Image('projects/mapbiomas-workspace/public/collection5/mapbiomas_collection50_integration_v1');
    if (process_year == 2020) {
      var ref_i = ref.select(['classification_' + (process_year - 1)])
      ref_i = ref_i.remap([3, 4, 11, 12, 15, 19, 21, 25, 33],
                          [3, 4, 12, 12, 21, 21, 21, 25, 33]);
    }
    if (process_year < 2020){
      var ref_i = ref.select(['classification_' + process_year]);
      ref_i = ref_i.remap([3, 4, 11, 12, 15, 19, 21, 25, 33],
                          [3, 4, 12, 12, 21, 21, 21, 25, 33]);
    }
    
    // corrigir transição
    var image_i_geo4_for = ref_i.updateMask(ref_i.eq(3)).clip(geometry4);
    var image_i_geo4_sav = ref_i.updateMask(ref_i.eq(4)).clip(geometry4);
    var image_i_geo4 = image_i_geo4_for.blend(image_i_geo4_sav);
    image_i = ee.ImageCollection([image_i, image_i_geo4]).mosaic();
    
  // add band
  remmaped_collection = remmaped_collection
                          .addBands(image_i.select(['remapped'],
                          ['classification_' + process_year]));
  });
  
  print ('adjusted collection', remmaped_collection);
  Map.addLayer(remmaped_collection.select(['classification_2020']), vis, 'remap' , true);

  remmaped_collection = remmaped_collection
            .set('collection', '6')
            .set('version', version)
            .set('biome', 'CERRADO');
            
  // clip to geometry
  remmaped_collection = remmaped_collection.clip(geometry3);
  //Map.addLayer(remmaped_collection.geometry(), vis, 'remap geo' , true);

  // export to mapbiomas-worskpace asset
  Export.image.toAsset({
    'image': remmaped_collection,
    'description': prefixo + version_out,
    'assetId': dir + prefixo + version_out,
     'pyramidingPolicy': {
        '.default': 'mode'
    },
    'region': remmaped_collection.geometry(),
    'scale': 30,
    'maxPixels': 1e13
});

//Map.addLayer(regions, vis, 'regioes');
